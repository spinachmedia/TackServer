{"changed":true,"filter":false,"title":"postTack.js","tooltip":"/routes/postTack.js","value":"/**\n * \n * RESTAPI　近い順に50件のTackを取得する\n * 座標情報がない場合、東京駅を中心座標とする\n * \n */\n\nvar express = require('express');\nvar uuid = require('node-uuid');\nvar router = express.Router();\n\n\nvar app = express();\n\n//追加\nvar mongodb = require('mongodb');\n//DBAオブジェクト\nvar TACK_INFO;\n\n//mongoDBに接続\nmongodb.MongoClient.connect(\"mongodb://localhost:27017/Tack\", function(err, database) {\n  if(err){}\n  TACK_INFO = database.collection(\"TACK_INFO\");\n  TACK_INFO.ensureIndex({loc: \"2dsphere\"}, {}, function(err, result) {if(err){}console.log(result)});\n});\n\n//更にルーティング\nrouter.post(\"/\", function(req, res) {\n  \n  //Facebookのログインをしていない場合、弾く。\n  var tack_id = uuid.v4();\n  var sns_id = req.body.sns_id;\n  var category = req.body.category;\n  var place_name = req.body.place_name;\n  var comment = req.body.comment;\n  var lat = req.body.lat;\n  var lng = req.body.lng;\n  var has_file_flg = req.body.has_file_flg;\n  var files = req.files\n  \n  var file_path;\n  \n  if(sns_id == null){\n    sns_id = null;\n    //エラーを返さないとね\n    //res.send({\"error\":\"sns_id is not found.\"});\n  }\n  \n  if(category == null){\n    category = \"FOOD\";\n  }\n  \n  if(place_name == null){\n    place_name = \"場所情報なし\";\n  }\n  \n  //空っぽの場合は東京駅の座標\n  if(lat == null){\n    lat = 35.681382;\n  }else{\n    lat = parseFloat(lat)\n  }\n  \n  if(lng == null){\n    lng = 139.766084;\n  }else{\n    lng = parseFloat(lng)\n  }\n  \n  \n  if(files.file_data == null){\n    has_file_flg = false;\n  }else{\n    \n    has_file_flg = true\n    \n    //ファイルを保存する\n    var tmp_path = files.file_data.path; \n    var target_path = './public/images/' + files.file_data.name;\n    var fs = require('fs');\n    file_path = target_path;\n    fs.rename(tmp_path, target_path, function(err) {\n        if (err) throw err;\n        fs.unlink(tmp_path, function() {\n        });\n    });\n    \n  }\n  \n  \n  var insertObject = {\n    tack_id: tack_id,\n    sns_id: sns_id,\n    sns_category: \"fb\",\n    category: category,\n    place_name: place_name,\n    comment: comment,\n    good_tack: 0,\n    city_code: 0,\n    lat: lat,\n    lng: lng,\n    loc: [lng,lat],\n    has_file_flg: has_file_flg,\n    file_path: file_path,\n    date: new Date().toISOString(),//2014-03-07T10:00:00\n  };\n  \n  \n  // 座標から近い順に50件を取得\n  // 非同期コールバック処理なので注意。\n  // コレクションから値を取得する。\n  TACK_INFO.insert(insertObject,function(err, records) {\n    \n    if(err){console.log(err)}\n    \n    //レスポンスのテンプレートを指定し、パラメータを第二引数で渡す\n    //RESTAPIなのでテンプレートは利用しない\n    res.send({\"items\":records});\n    \n  });//find\n  \n});//router\n\nmodule.exports = router;\n","undoManager":{"mark":98,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":29,"column":21},"end":{"row":29,"column":22},"action":"insert","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":29,"column":22},"end":{"row":29,"column":23},"action":"insert","lines":["4"]}]}],[{"group":"doc","deltas":[{"start":{"row":7,"column":33},"end":{"row":8,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":8,"column":0},"end":{"row":8,"column":32},"action":"insert","lines":["var uuid = require('node-uuid');"]}]}],[{"group":"doc","deltas":[{"start":{"row":94,"column":22},"end":{"row":95,"column":0},"action":"insert","lines":["",""]},{"start":{"row":95,"column":0},"end":{"row":95,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":95,"column":4},"end":{"row":95,"column":11},"action":"insert","lines":["tack_id"]}]}],[{"group":"doc","deltas":[{"start":{"row":95,"column":11},"end":{"row":95,"column":18},"action":"insert","lines":["tack_id"]}]}],[{"group":"doc","deltas":[{"start":{"row":95,"column":11},"end":{"row":95,"column":12},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":95,"column":12},"end":{"row":95,"column":13},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":95,"column":20},"end":{"row":95,"column":21},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":98,"column":27},"end":{"row":99,"column":0},"action":"insert","lines":["",""]},{"start":{"row":99,"column":0},"end":{"row":99,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":99,"column":4},"end":{"row":99,"column":11},"action":"insert","lines":["comment"]}]}],[{"group":"doc","deltas":[{"start":{"row":99,"column":11},"end":{"row":99,"column":12},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":99,"column":12},"end":{"row":99,"column":19},"action":"insert","lines":["comment"]}]}],[{"group":"doc","deltas":[{"start":{"row":99,"column":19},"end":{"row":99,"column":20},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":99,"column":12},"end":{"row":99,"column":13},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":99,"column":21},"end":{"row":100,"column":0},"action":"insert","lines":["",""]},{"start":{"row":100,"column":0},"end":{"row":100,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":100,"column":4},"end":{"row":100,"column":19},"action":"insert","lines":["good_tack_count"]}]}],[{"group":"doc","deltas":[{"start":{"row":100,"column":13},"end":{"row":100,"column":19},"action":"remove","lines":["_count"]},{"start":{"row":100,"column":13},"end":{"row":100,"column":14},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":100,"column":14},"end":{"row":100,"column":15},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":100,"column":15},"end":{"row":100,"column":16},"action":"insert","lines":["0"]}]}],[{"group":"doc","deltas":[{"start":{"row":100,"column":16},"end":{"row":100,"column":17},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":100,"column":17},"end":{"row":101,"column":0},"action":"insert","lines":["",""]},{"start":{"row":101,"column":0},"end":{"row":101,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":4},"end":{"row":101,"column":5},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":5},"end":{"row":101,"column":6},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":6},"end":{"row":101,"column":7},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":7},"end":{"row":101,"column":8},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":8},"end":{"row":101,"column":9},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":9},"end":{"row":101,"column":10},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":10},"end":{"row":101,"column":11},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":11},"end":{"row":101,"column":12},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":12},"end":{"row":101,"column":13},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":13},"end":{"row":101,"column":14},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":14},"end":{"row":101,"column":15},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":15},"end":{"row":101,"column":16},"action":"insert","lines":["0"]}]}],[{"group":"doc","deltas":[{"start":{"row":101,"column":16},"end":{"row":101,"column":17},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":96,"column":19},"end":{"row":97,"column":0},"action":"insert","lines":["",""]},{"start":{"row":97,"column":0},"end":{"row":97,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":4},"end":{"row":97,"column":5},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":5},"end":{"row":97,"column":6},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":6},"end":{"row":97,"column":7},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":7},"end":{"row":97,"column":8},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":8},"end":{"row":97,"column":9},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":9},"end":{"row":97,"column":10},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":9},"end":{"row":97,"column":10},"action":"remove","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":9},"end":{"row":97,"column":10},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":10},"end":{"row":97,"column":11},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":11},"end":{"row":97,"column":12},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":12},"end":{"row":97,"column":13},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":13},"end":{"row":97,"column":14},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":14},"end":{"row":97,"column":15},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":15},"end":{"row":97,"column":16},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":16},"end":{"row":97,"column":17},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":17},"end":{"row":97,"column":18},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":18},"end":{"row":97,"column":20},"action":"insert","lines":["\"\""]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":19},"end":{"row":97,"column":20},"action":"remove","lines":["\""]},{"start":{"row":97,"column":19},"end":{"row":97,"column":20},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":20},"end":{"row":97,"column":21},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":20},"end":{"row":97,"column":21},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":20},"end":{"row":97,"column":21},"action":"insert","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":21},"end":{"row":97,"column":22},"action":"insert","lines":["\""]}]}],[{"group":"doc","deltas":[{"start":{"row":97,"column":22},"end":{"row":97,"column":23},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":104,"column":13},"end":{"row":105,"column":0},"action":"insert","lines":["",""]},{"start":{"row":105,"column":0},"end":{"row":105,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":4},"end":{"row":105,"column":5},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":5},"end":{"row":105,"column":6},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":6},"end":{"row":105,"column":7},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":7},"end":{"row":105,"column":8},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":7},"end":{"row":105,"column":8},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":7},"end":{"row":105,"column":8},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":8},"end":{"row":105,"column":9},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":9},"end":{"row":105,"column":11},"action":"insert","lines":["[]"]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":11},"end":{"row":105,"column":12},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":10},"end":{"row":105,"column":11},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":11},"end":{"row":105,"column":12},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":12},"end":{"row":105,"column":13},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":13},"end":{"row":105,"column":14},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":14},"end":{"row":105,"column":15},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":15},"end":{"row":105,"column":16},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":105,"column":16},"end":{"row":105,"column":17},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":10},"end":{"row":74,"column":11},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":11},"end":{"row":74,"column":12},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":12},"end":{"row":74,"column":13},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":13},"end":{"row":74,"column":14},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":11},"end":{"row":74,"column":14},"action":"remove","lines":["cou"]},{"start":{"row":74,"column":11},"end":{"row":74,"column":16},"action":"insert","lines":["count"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":23},"end":{"row":74,"column":24},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":22},"end":{"row":74,"column":23},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":20},"end":{"row":74,"column":22},"action":"remove","lines":["nu"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":19},"end":{"row":74,"column":20},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":18},"end":{"row":74,"column":19},"action":"remove","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":17},"end":{"row":74,"column":18},"action":"remove","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":17},"end":{"row":74,"column":18},"action":"insert","lines":[">"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":17},"end":{"row":74,"column":18},"action":"remove","lines":[">"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":17},"end":{"row":74,"column":18},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":18},"end":{"row":74,"column":19},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":19},"end":{"row":74,"column":20},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":20},"end":{"row":74,"column":21},"action":"insert","lines":["0"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":11},"end":{"row":74,"column":16},"action":"remove","lines":["count"]},{"start":{"row":74,"column":11},"end":{"row":74,"column":20},"action":"insert","lines":["file_data"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":24},"end":{"row":74,"column":25},"action":"remove","lines":["0"]},{"start":{"row":74,"column":24},"end":{"row":74,"column":25},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":25},"end":{"row":74,"column":26},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":26},"end":{"row":74,"column":27},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":27},"end":{"row":74,"column":28},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":70,"column":0},"end":{"row":73,"column":2},"action":"remove","lines":["  if(has_file_flg == null){","    has_file_flg = false;","  }","  "]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":2},"end":{"row":70,"column":0},"action":"remove","lines":["",""]}]}]]},"ace":{"folds":[],"scrolltop":1028.9090156555176,"scrollleft":0,"selection":{"start":{"row":69,"column":2},"end":{"row":69,"column":2},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":74,"state":"no_regex","mode":"ace/mode/javascript"}},"timestamp":1431274601160}